"use strict";(self.webpackChunk_tiledb_inc_tiledb_prompt_options=self.webpackChunk_tiledb_inc_tiledb_prompt_options||[]).push([[574],{7574:(e,t,n)=>{n.r(t),n.d(t,{default:()=>C});var a=n(8883),o=n(6455),s=n(8324),i=n(3869),l=n(170),r=n(5294),d=n(8959);let c;var u;!function(e){e.v1="v1",e.v2="v2"}(u||(u={}));const p=async(e,t=u.v1)=>(c||(c=await async function(e="",t={}){const n=d.ServerConnection.makeSettings(),a=r.URLExt.join(n.baseUrl,"get_access_token","");let o;try{o=await d.ServerConnection.makeRequest(a,t,n)}catch(e){throw new d.ServerConnection.NetworkError(e)}let s=await o.text();if(s.length>0)try{s=JSON.parse(s)}catch(e){console.log("Not a JSON response body.",o)}if(!o.ok)throw new d.ServerConnection.ResponseError(o,s.message);return s}()),new e({apiKey:c.token,basePath:`${c.api_host}/${t}`}));var m=n(9321);const _=(e,t,n,a)=>{t.forEach(((t,o)=>{const s=a?a[o]:t,i=document.createElement("option");i.setAttribute("value",t),i.setAttribute("label",s),n&&n===t&&i.setAttribute("selected","true"),e.append(i)}))};var h=n(3706);const{UserApi:v,OrganizationApi:b}=a.v1,{UserApi:g}=a.v2;class f extends h.Widget{constructor(e){const t=document.createElement("div");super({node:t}),this.addClass("TDB-Prompt-Dialog"),this.app=e.app,this.docManager=e.docManager,this.isDefaultS3PathInputDirty=!1;const n=document.createElement("label");n.textContent="Name:";const a=document.createElement("input");a.setAttribute("type","text"),a.setAttribute("value","untitled"),a.setAttribute("name","name"),a.setAttribute("required","true"),a.setAttribute("pattern","^[^0-9][A-Za-z0-9_-]*"),a.setAttribute("maxlength","250"),a.setAttribute("oninput",'this.setCustomValidity("")'),a.addEventListener("invalid",(e=>{e.target.validity.valueMissing?e.target.setCustomValidity("This field is required"):e.target.setCustomValidity('Name should not start with a numeric character and consist of letters(a -z and A-Z), numbers, "_" and "-" only')}));const o=document.createElement("label");o.textContent="Cloud storage path:";const s=document.createElement("input");s.setAttribute("type","text"),s.setAttribute("value",e.defaultS3Path),s.setAttribute("name","s3_prefix"),s.onchange=()=>{this.isDefaultS3PathInputDirty=!0};const i=document.createElement("label");i.textContent="Cloud storage credentials:";const l=document.createElement("select");l.setAttribute("name","s3_credentials");const r=e.credentials.map((e=>e.name));_(l,r,e.defaultS3CredentialName);const d=document.createElement("a");d.textContent="Add credentials",d.classList.add("TDB-Prompt-Dialog__link"),d.onclick=()=>{window.parent.postMessage("@tiledb/prompt_options::add_credentials","*")};const c=document.createElement("label");c.textContent="Owner:";const m=document.createElement("select");_(m,e.owners,e.selectedOwner),m.setAttribute("name","owner"),m.onchange=async t=>{const n=t.currentTarget.value;var a;(a=l).value="",a.innerHTML="";const o=await p(g,u.v2),i=(await o.listCredentials(n)).data.credentials||[],r=e.owners[0],{default_s3_path_credentials_name:d,default_s3_path:c}=await(async(e,t)=>{var n,a,o,s;const i=await p(v),l=await p(b),r=e!==t,d=await(r?l.getOrganization(t):i.getUser());return{default_s3_path:(null===(a=null===(n=d.data.asset_locations)||void 0===n?void 0:n.notebooks)||void 0===a?void 0:a.path)||d.data.default_s3_path,default_s3_path_credentials_name:(null===(s=null===(o=d.data.asset_locations)||void 0===o?void 0:o.notebooks)||void 0===s?void 0:s.credentials_name)||d.data.default_s3_path_credentials_name}})(r,n);c&&!this.isDefaultS3PathInputDirty&&s.setAttribute("value",c);const m=i.map((e=>e.name));_(l,m,d)};const h=document.createElement("label");h.textContent="Kernel:";const f=document.createElement("select");f.setAttribute("name","kernel");const w=this.docManager.services.kernelspecs.specs,y=Object.keys(w.kernelspecs),k=Object.values(w.kernelspecs).map((e=>e.display_name)),C=w.default;_(f,y,C,k);const D=document.createElement("form");D.classList.add("TDB-Prompt-Dialog__form"),t.appendChild(D),D.appendChild(n),D.appendChild(a),D.appendChild(o),D.appendChild(s),D.appendChild(i),D.appendChild(l),D.appendChild(d),D.appendChild(c),D.appendChild(m),D.appendChild(h),D.appendChild(f),window.addEventListener("message",(async t=>{var n,a;if("TILEDB_UPDATED_CREDENTIALS"===t.data){const t=await p(g,u.v2),o=e.owners[0],s=await t.listCredentials(o);l.innerHTML="";const i=null===(a=null===(n=null==s?void 0:s.data)||void 0===n?void 0:n.credentials)||void 0===a?void 0:a.map((e=>e.name));_(l,i,e.defaultS3CredentialName)}}))}onAfterAttach(){var e;const t=null===(e=document.querySelector(".TDB-Prompt-Dialog"))||void 0===e?void 0:e.nextElementSibling,n=document.createElement("button");n.classList.add("TDB-Prompt-Dialog__styled-btn","jp-Dialog-button","jp-mod-accept","jp-mod-styled"),n.textContent="GO",n.onclick=()=>function(e,t){const n=document.querySelector(".TDB-Prompt-Dialog__styled-btn"),a=document.querySelector(".TDB-Prompt-Dialog__btn"),o=document.querySelector(".TDB-Prompt-Dialog__form"),s=new FormData(o);if(!o.reportValidity())return;n.textContent="";const i=document.createElement("div");i.classList.add("TDB-Prompt-Dialog__loader"),n.appendChild(i);const{name:l,owner:r,s3_credentials:d,s3_prefix:c,kernel:u}=function(e){const t={};for(const n of e.keys())t[n]=e.get(n);return t}(s),p={name:l,s3_prefix:c,s3_credentials:d},_={name:u},h={path:"cloud/owned/".concat(r,"/"),type:"notebook",options:JSON.stringify(p)};t.services.contents.newUntitled(h).then((t=>{e.commands.execute("docmanager:open",{factory:"Notebook",path:t.path+".ipynb",kernel:_}).finally((()=>{a.click()}))})).catch((e=>{(0,m.showErrorMessage)("Error",e),a.click()}))}(this.app,this.docManager),t.appendChild(n)}getValue(){const e=this.node.getElementsByTagName("input"),t=this.node.getElementsByTagName("select");return{name:e[0].value,s3_prefix:e[1].value,s3_credentials:t[0].value,owner:t[1].value,kernel:t[2].value}}}const{UserApi:w}=a.v1,{UserApi:y}=a.v2,k={activate:function(e,t,n,a,o){const s="tiledb-prompt-notebook-options:open";e.commands.addCommand(s,{caption:"Prompt the user for TileDB notebook options",execute:async()=>{var t,a,o,s,i;const l=await p(w),r=await p(y,u.v2),d=(await l.getUser()).data,c=d.username,_=await r.listCredentials(c),h=[c],v=function(e){const t=[];return e.forEach((e=>{const n=e.organization_name;"public"!==n&&~(null==e?void 0:e.allowed_actions.indexOf("write"))&&t.push(n)})),t}(d.organizations||[]),b=(null===(a=null===(t=d.asset_locations)||void 0===t?void 0:t.notebooks)||void 0===a?void 0:a.path)||d.default_s3_path||"s3://tiledb-user/notebooks";h.push(...v),(e=>{(0,m.showDialog)({body:new f(e),buttons:[m.Dialog.cancelButton(),m.Dialog.okButton({label:"GO",className:"TDB-Prompt-Dialog__btn"})],title:"TileDB Notebook Options"})})({owners:h,credentials:(null===(o=_.data)||void 0===o?void 0:o.credentials)||[],defaultS3Path:b,defaultS3CredentialName:(null===(i=null===(s=d.asset_locations)||void 0===s?void 0:s.notebooks)||void 0===i?void 0:i.credentials_name)||d.default_s3_path_credentials_name,app:e,docManager:n,selectedOwner:d.username})},isEnabled:()=>!0,label:"TileDB Notebook"}),o&&o.add({args:{isLauncher:!0,kernelName:"tiledb-prompt-notebook-options"},category:"Notebook",command:s,kernelIconUrl:"https://cloud.tiledb.com/static/img/tiledb-logo-jupyterlab.svg",rank:1}),t&&t.fileMenu.newMenu.addGroup([{command:s}],40),console.log("JupyterLab extension @tiledb/tiledb_prompt_options is activated.")},autoStart:!0,id:"tiledb-prompt-notebook-options",optional:[i.ILauncher],requires:[l.IMainMenu,o.IDocumentManager,s.IFileBrowserFactory]},C=k}}]);