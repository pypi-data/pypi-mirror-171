# automatically generated by auxilium
FROM {{ opts.base | default(aux.project.slug~"-python-deps-"~opts.version_slug, true) }} AS intermediary

USER container:container
WORKDIR /home/container

ARG PROJECT_DIR
COPY --chown=5000:5000 $PROJECT_DIR .
RUN /bin/sh ./devops/scripts/sdist untar

FROM {{ opts.base | default(aux.project.slug~"-python-deps-"~opts.version_slug, true) }}

USER container:container
WORKDIR /home/container

COPY --chown=container --from=intermediary /home/container/dist/{{ aux.project.second_name }}* /home/container/code/{{ aux.project.second_name }}
RUN pip install -e /home/container/code/{{ aux.project.second_name }} --no-cache

{% if opts.get("mode") == "django" %}
EXPOSE 8000

COPY --chown=container "{{aux.project.source_dir}}/manage.py" "code/{{ aux.project.second_name }}/{{aux.project.source_dir}}/manage.py"
COPY --chown=container "{{aux.project.source_dir}}/uwsgi.ini" "code/{{ aux.project.second_name }}/{{aux.project.source_dir}}/uwsgi.ini"
CMD ["/bin/sh", "-c", "python code/{{ aux.project.second_name }}/{{aux.project.source_dir}}/manage.py migrate && uwsgi --ini code/{{ aux.project.second_name }}/{{aux.project.source_dir}}/uwsgi.ini --http :8000"]
{% elif opts.get("mode") == "django+nginx" %}
EXPOSE 8004

COPY --chown=container "{{aux.project.source_dir}}/manage.py" "code/{{ aux.project.second_name }}/{{aux.project.source_dir}}/manage.py"
COPY --chown=container "{{aux.project.source_dir}}/uwsgi.ini" "code/{{ aux.project.second_name }}/{{aux.project.source_dir}}/uwsgi.ini"
CMD ["/bin/sh", "-c", "python code/{{ aux.project.second_name }}/{{aux.project.source_dir}}/manage.py migrate && uwsgi --ini code/{{ aux.project.second_name }}/{{aux.project.source_dir}}/uwsgi.ini --socket :8004"]
{% endif %}
